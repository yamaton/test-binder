#!/bin/bash

# https://repo2docker.readthedocs.io/en/latest/config_files.html#postbuild-run-code-after-installing-the-environment
# > Note that by default the build will not be stopped
# > if an error occurs inside a shell script. You should
# > include set -e or the equivalent at the start of the
# >  script to avoid errors being silently ignored.
set -ex


# install triton-lsp
# This path must be consistent with what's written in
# .jupyter/jupyter_server_config.json
mkdir -p /srv/conda/envs/notebook/etc/jupyter
npm install --prefix /srv/conda/envs/notebook/etc/jupyter yamaton/triton-lsp#dev


# pipx: install programs in each virtual environment
export PIPX_HOME=/srv/conda/pipx
mkdir -p "$PIPX_HOME"
TOOLS=( "$(cat ~/binder/_tools_pipx.txt)" )
for _tool in ${TOOLS[*]}; do
    echo "Installing ${_tool}"
    # retry if nonzero exit status occurs
    if [[ ! ($(pipx install "$_tool")) ]]; then
        echo "pipx retrying... $_tool"
        pipx uninstall "$_tool"
        pipx install "$_tool"
    fi
done


# Tweak exit code of the condax runner scripts
export CONDAX_HIDE_EXITCODE=1


# condax: install programs in each conda environment
mkdir -p /srv/conda/condax/envs
mkdir -p ~/.config/condax
echo "prefix_dir: /srv/conda/condax/envs" > ~/.config/condax/config.yaml

TOOLS=( "$(cat ~/binder/_tools_condax.txt)" )
for _tool in ${TOOLS[*]}; do
    echo "Installing ${_tool}"
    # retry if nonzero exit status occurs
    if [[ ! ($(condax install -c conda-forge -c bioconda "$_tool")) ]]; then
        echo "condax retrying... $_tool"
        condax remove "$_tool"
        condax install -c conda-forge -c bioconda --force "$_tool"
    fi
done

mamba clean --all --yes --force-pkgs-dirs

## Fix 404 Error with nbgitpuller link
## https://jupyterhub.github.io/nbgitpuller/install.html#nbgitpuller-link-shows-404-not-found
jupyter serverextension enable nbgitpuller --sys-prefix

# List extensions
jupyter serverextension list
jupyter server extension list
jupyter labextension list

## Change default settings for JupyterLab Extensions
mkdir -p "$NB_PYTHON_PREFIX"/share/jupyter/lab/settings/
cp binder/overrides.json "$NB_PYTHON_PREFIX"/share/jupyter/lab/settings/
